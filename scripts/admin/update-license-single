#!/usr/bin/perl -w

# Copyright: (C) 2010 RobotCub Consortium
# Author: Paul Fitzpatrick
# CopyPolicy: Released under the terms of the LGPLv2.1 or later, see LGPL.TXT

my $fname = $ARGV[0];


my $std_license = "
/*
 * Copyright (C) 2006 Author McAuthor
 * CopyPolicy: Released under the terms of the GNU GPL v2.0.
 *
 */
";


print "$fname\n";

my $txt = "";
open(FIN,"<license_check/$fname");
while (<FIN>) {
    $txt .= $_;
}
close(FIN);

$txt =~ s/Department of Robotics Brain and Cognitive Sciences - Istituto Italiano di Tecnologia/IITRBCS/;
$txt =~ s/Robotics, Brain and Cognitive Sciences - Italian Institute of Technology .IIT./IITRBCS/;

$txt =~ s/Copy Policy/CopyPolicy/;

# Ali-style
$txt =~ s/2011 \(C\)/(C) 2011/;

$txt =~ s/Original code by Lee Thomason.*/Copyright: Lee Thomason/;

if (!($txt =~ /Thomason/)) {
    $txt =~ s|www.sourceforge.net/projects/tinyxml|Copyright: Lee Thomason|;
}

my $report = "skipped";

my $policy = "unknown";
my $copyright = "unknown";
my $authors = "";

my $quiet = 1;
if ($txt=~/license/i || $txt=~/copyright/i || $txt=~/rights/i) {
    $quiet = 0;
}

if ($txt=~/academic free/i || $quiet) {
    if (!($txt=~/CopyPolicy/)) {
	$policy = "default";
	$copyright = "default";
    }
}

if ($txt=~/GNU Lesser General Public license/) {
    if ($txt=~/we personally strongly object/) {
	$policy = "LGPL; non-binding note discouraging certain uses";
    }
}

if ($policy eq "unknown") {
    if ($txt =~ /GNU Lesser General Public License/) {
	if ($txt =~ /either version 2.1/) {
	    $policy = "LGPLv2.1 or later";
	}
    }
}

if ($policy eq "unknown") {
    if ($txt =~ /GNU General Public License/) {
	if ($txt =~ /version 2 or/) {
	    $policy = "GPLv2 or later";
	}
    }
}

if ($policy eq "unknown") {
    if ($txt =~ /GNU Library General Public/) {
	if ($txt =~ /version 2 of the License. or/) {
	    $policy = "LGPLv2 or later";
	}
    }
}

if ($policy eq "unknown") {
    if ($txt =~ /GNU Lesser General Public/) {
	if ($txt =~ /version 2 of the License. or/) {
	    $policy = "LGPLv2 or later";
	}
    }
}

if ($policy eq "default" && $copyright eq "default") {
    if ($txt =~ / rbock . / ||
	$txt =~ /Generated by gtkmmproc/ ||
	$txt =~ /This file is part of gtkdataboxmm/ ||
	$fname =~ /gtkdatabox.*txt$/) {
	# tinyxml has blanket LGPLv2.1 license; tolerate this for now
	$copyright = "Dr. Roland Bock";
	$policy = "LGPLv2.1 or later";
    }
}


if ($txt =~ /license/i || $txt =~ /copyright/i) {
}

$txt =~ s/The RobotCub Consortium\.?/RobotCub Consortium/ig;
$txt =~ s/Robotcub Consortium\.?/RobotCub Consortium/ig;

$txt =~ s/-->//;

#$txt =~ s/.*GNU General Public License, version 2 or.*/CopyPolicy: Released under the terms of the GNU GPL v2.0./;
 
if ($txt=~/CopyPolicy\:\s*(.*)/i) {
    $policy = $1;
}


if ($copyright eq "unknown") {
    if ($txt=~/copyright\:\s*([^\"\'\*\r\n]+)\s*[\n\r\*]/i) {
	$copyright = $1;
    } elsif ($txt =~ /copyright\:?\s*([^\(0-9][^\"\'\*\r\n]+)\s*[\n\r\*]/i) {
	$copyright = $1;
    }    
}

if ($txt =~ /(The author disclaims copyright to this source code)/) {
    $copyright = $1;
}

if ($txt =~ /here is a blessing/) {
    $policy = "In place of a legal notice, a blessing is given."
}

if ($policy =~ /unknown/) {
    if ($txt =~ /Permission is granted to anyone to use this software for any/) {
	if ($txt =~ /This notice may not be removed or altered from any source/) {
	    $policy = "zlib";
	} else {
	    $policy = "BSD";
	}
    }
    if ($txt =~ /Everyone is permitted to copy and distribute verbatim copies/) {
	$policy = "copying and distributing verbatim copies allowed";
    }
}

if ($txt =~ /Bayer pattern decoding functions/) {
    $copyright = "Damien Douxchamps and Frederic Devernay";
    $policy = "LGPLv2.1";
}

if ($txt =~ /Licensed to the Apache Software Foundation/) {
    $copyright = "Apache Software Foundation";
    $policy = "Apache License, Version 2.0";
}

if ($txt =~ /Alexander Chemeris/) {
    $policy = "BSD";
}

if ($copyright eq "unknown") {
    if ($txt =~ /Lee Thomason/) {
	$copyright = "Lee Thomason";
	$policy = "zlib";
    }
}

if ($copyright =~ /RobotCub/i || $copyright =~ /IITRBCS/i) {
    if ($txt =~ /authors?: *([^ \n\r].*[^ \n\r])/i) {
	$authors = $1;
	$authors =~ s/[^ \n\r]*\@[^ \n\r]*//g;
    }
}

$copyright =~ s/\s+$//g;
$copyright =~ s/^\s+//g;
$copyright =~ s/Â©/\(C\)/g;
$copyright =~ s/\xa9/\(C\)/g;
$policy =~ s/\s+$//g;
$policy =~ s/^\s+//g;

$copyright =~ s/Alex Bernardino/Alexandre Bernardino/;

if ($copyright eq "default") {
    # no copyright statement - only accept for example code
    # update: now putting copyright statement in example code
    #if (!($fname =~ /example\//)) {
    $copyright = "unknown";
    $report = "skipped";
    #}
}

if ($policy ne "default" || $copyright ne "default") {
    $report = "CopyPolicy [$policy] Copyright [$copyright]";
}

if ($policy eq "default") {
    $policy = "unknown";
}

$txt2 = $txt;

#if ($policy =~ /GNU GPL/) {
#    $report = "skipped";
#}

#system "echo \"$report $fname\" >> license-changes.txt";
if ($report ne "skipped") {
    my $authortxt = "";
    if ($authors ne "") {
	$authortxt = "  Authors: $authors\n";
    }
    my $txt = "$fname\n  Copyright: $copyright\n$authortxt  CopyPolicy: $policy\n\n";
    open(FOUT,">>license-changes.txt");
    print FOUT $txt;
    close(FOUT);
    if ($policy =~ /LGPLv2(.1)?( or later)?/ && !($txt =~ /Chris Morley/)) {
	open(FOUT,">>license-good.txt");
	print FOUT $txt;
	close(FOUT);
    } else {
	open(FOUT,">>license-odd.txt");
	print FOUT $txt;
	close(FOUT);
    }
}

if (0) {
    if ($copyright eq "default") {
	# no copyright information -> guess who wrote it
	my $ok = 1;
	if ($fname =~ /example\//) {
	    $ok = 1;
	}
	my $authors = "Paul Fitzpatrick";
	#my $authors = "Giorgio Metta";
	if ($ok) {
	    open(FOUT,">>license-changes.txt");
	    print FOUT "$fname needs copyright statement\n";
	    print FOUT "$fname author $authors\n";
	    close(FOUT);
	    
	    my $replacement = $std_license;
	    $replacement =~ s/Author McAuthor/$authors/;
	    
	    $txt2 =~ s/(\-\*\-\n)/$1$replacement\n/;
	}
    }
}



if (0) { # don't need to scrub AFL anymore
    if ($txt =~ /Academic Free License/) {
	my $authors = "paulfitz";
	if ($txt =~ /\/\/\/.*\#(.*)\#/) {
	    $authors = $1;
	}
	
	$authors =~ s/Add our.*/paulfitz, pasa/;
	$authors =~ s/paulfitz/Paul Fitzpatrick/;
	$authors =~ s/pasa/Giorgio Metta/;
	
	open(FOUT,">>license-changes.txt");
	print FOUT "$fname needs AFL stripped\n";
	print FOUT "$fname author $authors\n";
	close(FOUT);
	
	$replacement = $std_license;
	$replacement =~ s/Author McAuthor/$authors/;
	
#    $txt2 =~ s/\/\/\/\/\/\/\/\/\/(.|[\n\r])*Rosen(.|[\n\r])*Licensed under the Academic.*\n+(\/\/\/\n)*/$replacement/;
#    $txt2 =~ s/\/\/\/\/\/\/\/\/\/(.|[\n\r])*YARP_ROOT.conf(.|[\n\r])*Licensed under the Academic.*\n+(\/\/\/\n)*/$replacement/;
	$txt2 =~ s/\/\/\/(.|[\n\r])*Yet Another(.|[\n\r])*Licensed under the Academic.*\n+(\/\/\/\n)*/$replacement/;
    }
    if (!($txt =~ /CopyPolicy/)) { 
	open(FOUT,">>license-changes.txt");
	print FOUT "$fname needs CopyPolicy added\n";
	close(FOUT);
    }
}


if ($txt ne $txt2) {
    open(FOUT,">$fname.shadow");
    print FOUT $txt2;
    close(FOUT);
    system "echo should have changed $fname >> license-changes.txt";
    #system "emacs $fname &";
} else {
#    system "echo \"$report $fname\" >> license-changes.txt";
}


